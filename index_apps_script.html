<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë™í•´íŠ¹ìˆ˜êµìœ¡ì§€ì›ì„¼í„° ë¬¼í’ˆê²€ìƒ‰</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/ngc7331-kor/DHSE-Item-Search/main/icon-v9-192.png" />
    <meta name="theme-color" content="#6366f1" />
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Batang:wght@400;700&family=Outfit:wght@300;400;600;800&family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
      :root {
        --bg: #ffffff;
        --card: #f2f2f2;
        --primary: #4f46e5;
        --text: #0f172a;
        --text-sub: #64748b;
        --border: #e2e8f0;
        --input-bg: #ffffff;
        --input-border: #e2e8f0;
        --highlight: #dc2626;
        --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      }
      @media (prefers-color-scheme: dark) {
        :root {
          --bg: #111827;
          --card: #1f2937;
          --primary: #818cf8;
          --text: #f9fafb;
          --text-sub: #9ca3af;
          --border: #374151;
          --input-bg: #111827;
          --input-border: #374151;
          --highlight: #fb7185;
          --shadow: rgba(0, 0, 0, 0.5);
        }
      }
      html { background-color: var(--bg); height: 100%; margin: 0; }
      body {
        font-family: "Pretendard", sans-serif;
        background-color: var(--bg);
        color: var(--text);
        padding: 15px;
        margin: 0;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      .container { flex: 1; }
      .header {
        background: var(--card);
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        margin-bottom: 15px;
        position: relative;
        border: 1px solid var(--border);
        box-shadow: 0 2px 4px var(--shadow);
      }
      .header h3 {
        margin: 0;
        font-family: 'Gowun Batang', serif;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        font-weight: 700;
        color: var(--text);
      }
      .logo-icon { width: 32px; height: 32px; object-fit: contain; }
      .admin-btn {
        position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
        background: var(--card); border: 1px solid var(--border); color: var(--text);
        width: 35px; height: 35px; border-radius: 50%; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
      }
      .admin-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }
      .search-section {
        background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 15px;
        border: 1px solid var(--border); box-shadow: 0 2px 4px var(--shadow);
      }
      .search-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
      .form-group { position: relative; }
      .form-group label { display: block; font-size: 11px; color: var(--text-sub); margin-bottom: 4px; font-weight: 600; }
      input { width: 100%; padding: 10px; background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 6px; color: var(--text); box-sizing: border-box; }
      input:focus { outline: 2px solid var(--primary); border-color: transparent; }
      input[readonly] { cursor: pointer; background-color: var(--bg); opacity: 0.9; }
      .dropdown-list {
        position: absolute; top: 100%; left: 0; right: 0; background: var(--card);
        border: 1px solid var(--border); border-radius: 6px; z-index: 1000; display: none;
        box-shadow: 0 4px 10px var(--shadow);
      }
      .dropdown-list.show { display: block; }
      #itemL { max-height: 407px; overflow-y: auto; }
      .dropdown-item { padding: 10px; cursor: pointer; border-bottom: 1px solid var(--border); font-size: 13px; color: var(--text); }
      .dropdown-item:hover { background: var(--bg); color: var(--primary); font-weight: bold; }
      .dropdown-item:last-child { border-bottom: none; }
      .add-btn { background: #10b981; color: #fff; width: 100%; padding: 12px; border-radius: 8px; border: none; margin-bottom: 15px; display: none; cursor: pointer; font-weight: bold; }
      .add-btn.show { display: block; }
      #results { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 15px; }
      @media (max-width: 480px) { #results { grid-template-columns: 1fr; } }
      @media (min-width: 768px) { #results { grid-template-columns: 1fr 1fr; } }
      .result-card {
        background: var(--card); border-radius: 12px; display: flex; overflow: hidden;
        border: 1px solid var(--border); box-shadow: var(--shadow);
        transition: transform 0.2s, box-shadow 0.2s; height: 120px; cursor: pointer;
      }
      .result-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
      .img-box { width: 200px; background: #f1f5f9; flex-shrink: 0; display: flex; align-items: center; justify-content: center; overflow: hidden; }
      .img-box img { width: 100%; height: 100%; object-fit: cover; }
      .info-box {
        flex: 1; padding: 12px 15px; display: grid; grid-template-rows: 1fr auto; align-items: center;
      }
      .info-box h3 {
        margin: 0; font-size: 16px; color: var(--primary); font-weight: 700;
        line-height: 1.2; font-family: 'Gowun Batang', serif;
        display: flex; align-items: center; height: 100%;
      }
      .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0 15px; margin-top: 2px; }
      .info-row { font-size: 13px; line-height: 1.4; display: flex; align-items: center; gap: 8px; padding: 4px 0; }
      .info-row b { font-size: 11px; color: var(--text-sub); font-weight: 500; min-width: 42px; }
      .info-row .val { color: var(--text); font-weight: 600; }
      .info-row.full { grid-column: span 2; padding-top: 4px; padding-bottom: 4px; }
      .pagi-container { display: flex; align-items: center; justify-content: space-between; margin: 20px 0; gap: 10px; }
      .pagi-select { background: var(--input-bg); color: var(--text); border: 1px solid var(--border); padding: 8px; border-radius: 6px; font-size: 12px; }
      .pagi-nums { display: flex; gap: 4px; justify-content: center; flex: 1; }
      .pagi-btn { padding: 6px 12px; background: var(--card); border: 1px solid var(--border); color: var(--text); border-radius: 4px; cursor: pointer; font-size: 12px; }
      .pagi-btn.active { background: var(--primary); border-color: var(--primary); color: #fff; font-weight: bold; }
      .footer { text-align: right; padding: 30px 15px 15px; font-size: 10px; color: var(--text-sub); line-height: 1.6; }
      .footer b { font-weight: 700; color: var(--text); }
      .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
      .modal.show { display: flex; }
      .modal-content { background: var(--card); padding: 20px; border-radius: 12px; width: 90%; max-width: 360px; max-height: 80vh; overflow-y: auto; border: 1px solid var(--border); }
      .detail-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 3000; align-items: center; justify-content: center; backdrop-filter: blur(5px); overflow: auto; padding: 20px; }
      .detail-modal.show { display: flex; }
      .detail-wrapper { position: relative; width: 100%; max-width: 750px; margin: auto; animation: floatUp 0.3s ease-out; }
      @keyframes floatUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
      .detail-content { background: var(--card); border-radius: 20px; width: 100%; min-height: 450px; overflow: hidden; display: flex; flex-direction: column; border: none; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
      .detail-close-btn { position: absolute; top: -50px; right: 0; width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.9); color: #333; border: none; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10; transition: all 0.2s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.1); backdrop-filter: blur(4px); }
      .detail-close-btn:hover { transform: scale(1.1) rotate(90deg); background: #fff; color: var(--primary); }
      @media (min-width: 650px) { .detail-content { flex-direction: row; } .detail-img-area { width: 55%; height: auto; min-height: 400px; } .detail-info-area { width: 45%; padding: 40px 30px; overflow-y: auto; } }
      .detail-img-area { width: 100%; height: 300px; background: #f3f4f6; background-image: url("data:image/svg+xml;base64,..."); background-repeat: no-repeat; background-position: center; background-size: 60px; display: flex; align-items: center; justify-content: center; position: relative; }
      .detail-img-area img { width: 100%; height: 100%; object-fit: contain; z-index: 2; transition: opacity 0.3s; }
      .detail-info-area { padding: 25px; display: flex; flex-direction: column; justify-content: center; background: var(--card); }
      .detail-title { font-size: 1.6rem; color: var(--text); margin: 0 0 25px 0; font-weight: 800; line-height: 1.3; letter-spacing: -0.5px; border-bottom: 2px solid var(--primary); padding-bottom: 15px; display: inline-block; }
      .detail-row { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 15px; }
      .detail-row:last-child { border-bottom: none; }
      .detail-label { width: 70px; color: var(--text-sub); font-weight: 600; font-size: 0.9em; flex-shrink: 0; text-transform: uppercase; letter-spacing: 0.5px; }
      .detail-val { color: var(--text); font-weight: 500; flex: 1; line-height: 1.5; }
    </style>
  </head>
  <body>
    <div id="loadingOverlay" style="position:fixed; inset:0; background:rgba(255,255,255,0.9); z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center;">
      <div style="border:4px solid rgba(0,0,0,0.1); width:40px; height:40px; border-radius:50%; border-left-color:var(--primary); animation:spin 1s linear infinite; margin-bottom:15px;"></div>
      <div style="font-weight:bold; color:var(--text);">ìµœì‹  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
      <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
    </div>
    <div class="container">
      <div class="header">
        <h3><img src="https://raw.githubusercontent.com/ngc7331-kor/DHSE-Item-Search/main/icon-v9-512.png" class="logo-icon" alt="ë¡œê³ "> ë™í•´íŠ¹ìˆ˜êµìœ¡ì§€ì›ì„¼í„° ë¬¼í’ˆê²€ìƒ‰</h3>
        <button class="admin-btn" onclick="toggleAdmin()">ğŸ‘¤</button>
      </div>
      <button class="add-btn" id="addBtn" onclick="openModal()">â• ìƒˆ í•­ëª© ì¶”ê°€</button>
      <div class="search-section">
        <div class="search-form">
          <div class="form-group"><label>ì¢…ëª©</label><input type="text" id="cat" placeholder="ì„ íƒí•˜ì„¸ìš”" autocomplete="off" readonly /><div class="dropdown-list" id="catL"></div></div>
          <div class="form-group"><label>ì˜ì—­</label><input type="text" id="area" placeholder="ì„ íƒí•˜ì„¸ìš”" autocomplete="off" readonly /><div class="dropdown-list" id="areaL"></div></div>
          <div class="form-group"><label>í’ˆëª…</label><input type="text" id="item" placeholder="ì „ì²´/ì…ë ¥ (ììŒê°€ëŠ¥)" autocomplete="off" /><div class="dropdown-list" id="itemL"></div></div>
          <button onclick="currentPage = 1; performSearch();" style="background: var(--primary); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">ğŸ” ê²€ìƒ‰</button>
        </div>
      </div>
      <div id="results"></div>
      <div class="pagi-container" id="pagiBar" style="display: none">
        <select class="pagi-select" id="pageSize" onchange="currentPage = 1; renderUI();">
          <option value="10">10ê°œì”©</option><option value="20">20ê°œì”©</option><option value="50">50ê°œì”©</option><option value="100">100ê°œì”©</option>
        </select>
        <div class="pagi-nums" id="pagiNums"></div>
        <div style="width: 65px"></div>
      </div>
    </div>
    <div class="footer"><b>Â© 2025 L.To. ALL RIGHTS RESERVED. POWERED BY L.To</b><br />ë°ì´í„°ëŠ” ë™í•´íŠ¹ìˆ˜êµìœ¡ì§€ì›ì„¼í„°ì˜ ìì‚° ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•©ë‹ˆë‹¤.</div>
    <div class="detail-modal" id="detailModal" onclick="if (event.target.id === 'detailModal') closeDetailModal();">
      <div class="detail-wrapper">
        <button class="detail-close-btn" onclick="closeDetailModal()">Ã—</button>
        <div class="detail-content">
          <div class="detail-img-area"><img id="dt_img" src="" alt="ë¬¼í’ˆ ì‚¬ì§„" /></div>
          <div class="detail-info-area">
            <div class="detail-title" id="dt_name"></div>
            <div class="detail-row"><span class="detail-label">ì¢…ëª©</span><span class="detail-val" id="dt_cat"></span></div>
            <div class="detail-row"><span class="detail-label">ì˜ì—­</span><span class="detail-val" id="dt_area"></span></div>
            <div class="detail-row"><span class="detail-label">ìˆœë²ˆ</span><span class="detail-val" id="dt_num"></span></div>
            <div class="detail-row"><span class="detail-label">ìœ„ì¹˜</span><span class="detail-val" id="dt_loc"></span></div>
            <div class="detail-row"><span class="detail-label">ìˆ˜ëŸ‰</span><span class="detail-val" id="dt_qty"></span></div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal" id="modal">
      <div class="modal-content">
        <h3 id="mTitle">í•­ëª© ì¶”ê°€</h3>
        <div class="form-group"><label>ì¢…ëª©</label><input type="text" id="m_cat" autocomplete="off" /><div class="dropdown-list" id="mCatL"></div></div>
        <div class="form-group" style="margin-top: 10px"><label>ì˜ì—­</label><input type="text" id="m_area" autocomplete="off" /><div class="dropdown-list" id="mAreaL"></div></div>
        <div class="form-group" style="margin-top: 10px"><label>ìˆœë²ˆ</label><input type="text" id="m_num" readonly style="background: rgba(0, 0, 0, 0.1)" /></div>
        <div class="form-group" style="margin-top: 10px"><label>í’ˆëª…</label><input type="text" id="m_item" /></div>
        <div class="form-group" style="margin-top: 10px"><label>ìˆ˜ëŸ‰</label><input type="text" id="m_qty" /></div>
        <div class="form-group" style="margin-top: 10px"><label>ìœ„ì¹˜</label><input type="text" id="m_loc" /></div>
        <input type="file" id="f_input" hidden onchange="previewImg(event)" />
        <button onclick="document.getElementById('f_input').click()" style="width: 100%; padding: 10px; margin: 10px 0; background: #f59e0b; border: none; border-radius: 6px; color: #fff; cursor: pointer;">ğŸ“· ì‚¬ì§„ ì„ íƒ</button>
        <img id="m_prev" style="width: 100%; display: none; border-radius: 6px; margin-bottom: 10px;" />
        <div style="display: flex; gap: 10px">
          <button onclick="saveData()" style="flex: 1; padding: 10px; background: var(--primary); border: none; color: #fff; border-radius: 6px; font-weight: bold;">ì €ì¥</button>
          <button onclick="closeModal()" style="flex: 1; background: #444; border: none; color: #fff; border-radius: 6px;">ì·¨ì†Œ</button>
        </div>
      </div>
    </div>
    <script>
      const API_URL = 'https://script.google.com/macros/s/AKfycbxxSnINrMCjHbQNhndAn6nxbcVVljtszQeymF4yHwK3SmoAORTP5_pN0NooCrZDX8efGg/exec';
      class DataManager {
        constructor() { this.data = []; }
        async loadData() {
          const cached = localStorage.getItem('appData');
          if (cached) { try { this.data = JSON.parse(cached); } catch (e) { localStorage.removeItem('appData'); } }
          return await this.fetchAndCache();
        }
        async fetchAndCache() {
          try {
            const response = await fetch(API_URL);
            const result = await response.json();
            if (result.success) {
              const newDataStr = JSON.stringify(result.data);
              const oldDataStr = localStorage.getItem('appData');
              if (newDataStr !== oldDataStr) { this.data = result.data; localStorage.setItem('appData', newDataStr); window.dispatchEvent(new CustomEvent('data-updated')); }
              return this.data;
            } else { throw new Error(result.message || 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨'); }
          } catch (e) { if (this.data.length === 0) alert("ì˜¤ë¥˜: " + e.message); return this.data; }
        }
        getAllData() { return this.data; }
        searchData(c, a, i) {
          return this.data.filter(d => {
            const matchCat = (c === 'ì „ì²´' || !c) ? true : (c === 'ë¯¸ì…ë ¥' ? d.ì¢…ëª© === '' : d.ì¢…ëª© === c);
            const matchArea = (a === 'ì „ì²´' || !a) ? true : (a === 'ë¯¸ì…ë ¥' ? d.ì˜ì—­ === '' : d.ì˜ì—­ === a);
            const dataItemName = (d.í’ˆëª… || '').trim() === '' ? 'ë¯¸ì…ë ¥' : d.í’ˆëª…;
            const matchItem = (i === 'ì „ì²´' || !i) ? true : dataItemName.includes(i);
            return matchCat && matchArea && matchItem;
          });
        }
        getNextNumber(category) {
          const prefix = category.substring(0, 2);
          const filtered = this.data.filter(d => (d.ìˆœë²ˆ || '').startsWith(prefix));
          if (filtered.length === 0) return prefix + "-001";
          const numbers = filtered.map(d => { const parts = d.ìˆœë²ˆ.split('-'); return parts.length > 1 ? parseInt(parts[1], 10) : 0; });
          const nextNum = (Math.max(...numbers) + 1).toString().padStart(3, '0');
          return prefix + "-" + nextNum;
        }
        async addData(obj) {
          try {
            const payload = { action: 'add', item: { ì¢…ëª©: obj.ì¢…ëª© === 'ë¯¸ì…ë ¥' ? '' : obj.ì¢…ëª©, ì˜ì—­: obj.ì˜ì—­ === 'ë¯¸ì…ë ¥' ? '' : obj.ì˜ì—­, ìˆœë²ˆ: obj.ìˆœë²ˆ || '', í’ˆëª…: obj.í’ˆëª… === 'ë¯¸ì…ë ¥' ? '' : obj.í’ˆëª…, ìˆ˜ëŸ‰: obj.ìˆ˜ëŸ‰ || '', ìœ„ì¹˜: obj.ìœ„ì¹˜ || '', ì‚¬ì§„: obj.ì‚¬ì§„ || '' } };
            await fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            this.data.push(payload.item); return { success: true, message: 'ì €ì¥ ìš”ì²­ ì™„ë£Œ' };
          } catch (e) { return { success: false, message: e.message }; }
        }
        async updateData(old, n) {
          try {
            const payload = { action: 'update', oldItem: old, item: { ì¢…ëª©: n.ì¢…ëª© === 'ë¯¸ì…ë ¥' ? '' : n.ì¢…ëª©, ì˜ì—­: n.ì˜ì—­ === 'ë¯¸ì…ë ¥' ? '' : n.ì˜ì—­, ìˆœë²ˆ: n.ìˆœë²ˆ, í’ˆëª…: n.í’ˆëª… === 'ë¯¸ì…ë ¥' ? '' : n.í’ˆëª…, ìˆ˜ëŸ‰: n.ìˆ˜ëŸ‰, ìœ„ì¹˜: n.ìœ„ì¹˜, ì‚¬ì§„: n.ì‚¬ì§„ || '' } };
            await fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const idx = this.data.findIndex(d => d.ìˆœë²ˆ === old.ìˆœë²ˆ && d.ì¢…ëª© === old.ì¢…ëª©);
            if (idx !== -1) { this.data[idx] = payload.item; }
            return { success: true, message: 'ìˆ˜ì • ìš”ì²­ ì™„ë£Œ' };
          } catch (e) { return { success: false, message: e.message }; }
        }
        async deleteData(obj) {
          try {
            const payload = { action: 'delete', item: obj };
            await fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const idx = this.data.findIndex(d => d.ìˆœë²ˆ === obj.ìˆœë²ˆ && d.ì¢…ëª© === obj.ì¢…ëª©);
            if (idx !== -1) this.data.splice(idx, 1);
            return { success: true, message: 'ì‚­ì œ ìš”ì²­ ì™„ë£Œ' };
          } catch (e) { return { success: false, message: e.message }; }
        }
      }
      const db = new DataManager();
      let isAdmin = false; 
      let cache = { cats: [], areas: {}, items: {}, allAreas: [], allItems: [] };
      let fullData = []; let currentRenderedData = []; let currentPage = 1; let currentMode = 'add'; let editD = null; let isInitialLoad = true;
      function getJamos(str) {
        const cho = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
        const jung = ["ã…","ã…","ã…‘","ã…’","ã…“","ã…”","ã…•","ã…–","ã…—","ã…˜","ã…™","ã…š","ã…›","ã…œ","ã…","ã…","ã…Ÿ","ã… ","ã…¡","ã…¢","ã…£"];
        const jong = ["","ã„±","ã„²","ã„³","ã„´","ã„µ","ã„¶","ã„·","ã„¹","ã„º","ã„»","ã„¼","ã„½","ã„¾","ã„¿","ã…€","ã…","ã…‚","ã…„","ã……","ã…†","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
        let res = "";
        for (let i = 0; i < str.length; i++) {
          const c = str.charCodeAt(i);
          if (c >= 0xAC00 && c <= 0xD7A3) { const code = c - 0xAC00; res += cho[Math.floor(code / 588)] + jung[Math.floor((code % 588) / 28)] + jong[code % 28]; }
          else { res += str[i]; }
        }
        return res;
      }
      function isMatch(text, query) {
        if (!query) return true; if (!text) return false;
        const t = text.toString(); const q = query.toString();
        return t.includes(q) || getJamos(t).includes(getJamos(q));
      }
      function customSort(a, b) {
        if (a === 'ë¯¸ì…ë ¥') return 1; if (b === 'ë¯¸ì…ë ¥') return -1;
        if (a === 'ì „ì²´') return -1; if (b === 'ì „ì²´') return 1;
        return a.toString().localeCompare(b.toString(), 'ko-KR', { numeric: true });
      }
      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; }
        return array;
      }
      window.onload = () => { preload(); setupDropdowns(); window.addEventListener('data-updated', () => { preload(); }); };
      async function preload() {
        try {
          const data = await db.loadData();
          const cleanData = data.map(d => ({ ...d, ì¢…ëª©: (d.ì¢…ëª© && d.ì¢…ëª©.toString().trim()) || 'ë¯¸ì…ë ¥', ì˜ì—­: (d.ì˜ì—­ && d.ì˜ì—­.toString().trim()) || 'ë¯¸ì…ë ¥', í’ˆëª…: (d.í’ˆëª… && d.í’ˆëª….toString().trim()) || 'ë¯¸ì…ë ¥' }));
          cache.cats = ['ì „ì²´', ...new Set(cleanData.map(d => d.ì¢…ëª©))].sort(customSort);
          cache.allAreas = ['ì „ì²´', ...new Set(cleanData.map(d => d.ì˜ì—­))].sort(customSort);
          cache.allItems = ['ì „ì²´', ...new Set(cleanData.map(d => d.í’ˆëª…))].sort(customSort);
          cache.cats.forEach(c => {
            if(c === 'ì „ì²´') return;
            const cD = cleanData.filter(d => d.ì¢…ëª© === c);
            cache.areas[c] = ['ì „ì²´', ...new Set(cD.map(d => d.ì˜ì—­))].sort(customSort);
            cache.areas[c].forEach(a => { cache.items[c+'_'+a] = ['ì „ì²´', ...new Set(cD.filter(d => d.ì˜ì—­ === a).map(d => d.í’ˆëª…))].sort(customSort); });
          });
          // v9: ì´ˆê¸° ì§„ì… ì‹œ ëœë¤ ë°°ì¹˜
          fullData = shuffleArray(cleanData); 
          isInitialLoad = false; renderUI(); 
        } catch (e) { console.error("Preload Failed:", e); }
        finally { const loader = document.getElementById('loadingOverlay'); if(loader) loader.style.display = 'none'; }
      }
      function setupDropdowns() {
        const bind = (id, lid, dataFn) => {
          const el = document.getElementById(id); const listEl = document.getElementById(lid); const isStrict = el.hasAttribute('readonly');
          const showFilteredList = () => {
            const val = el.value.trim(); let items = dataFn();
            if (!isStrict && val) { items = items.filter(i => isMatch(i, val) && i !== 'ì „ì²´'); if (items.length === 0) items = ['ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ']; }
            listEl.innerHTML = items.map(i => `<div class="dropdown-item">${i}</div>`).join('');
            document.querySelectorAll('.dropdown-list').forEach(x => x.classList.remove('show')); listEl.classList.add('show');
            Array.from(listEl.children).forEach(child => {
              child.onclick = (e) => {
                e.stopPropagation(); if (child.textContent === 'ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ') return;
                el.value = child.textContent; listEl.classList.remove('show');
                if (id === 'cat') { document.getElementById('area').value = ''; document.getElementById('item').value = ''; }
                if (id === 'm_cat') { document.getElementById('m_num').value = db.getNextNumber(el.value); }
              };
            });
          };
          el.onclick = (e) => { e.stopPropagation(); if (!isStrict && el.value) el.value = ''; showFilteredList(); };
          if (!isStrict) el.oninput = () => showFilteredList();
        };
        bind('cat', 'catL', () => cache.cats);
        bind('area', 'areaL', () => { const c = document.getElementById('cat').value; return (c && c !== 'ì „ì²´' && cache.areas[c]) ? cache.areas[c] : cache.allAreas; });
        bind('item', 'itemL', () => {
          const c = document.getElementById('cat').value || 'ì „ì²´'; const a = document.getElementById('area').value || 'ì „ì²´';
          if (c === 'ì „ì²´' && a === 'ì „ì²´') return cache.allItems;
          if (c !== 'ì „ì²´' && cache.items[c+'_'+a]) return cache.items[c+'_'+a];
          const filtered = db.getAllData().filter(d => (c==='ì „ì²´'||d.ì¢…ëª©===c) && (a==='ì „ì²´'||d.ì˜ì—­===a)).map(d=>d.í’ˆëª…);
          return ['ì „ì²´', ...new Set(filtered)].sort(customSort);
        });
        bind('m_cat', 'mCatL', () => cache.cats.filter(c => c !== 'ì „ì²´'));
        bind('m_area', 'mAreaL', () => cache.allAreas.filter(a => a !== 'ì „ì²´'));
        document.addEventListener('click', (e) => { if (!e.target.closest('.form-group')) document.querySelectorAll('.dropdown-list').forEach(x => x.classList.remove('show')); });
      }
      function getInstantImgUrl(url) {
        if (!url) return '';
        try {
          let id = '';
          if (url.includes('id=')) { const match = url.match(/id=([^&]+)/); if (match) id = match[1]; } 
          else if (url.includes('/file/d/')) { const match = url.match(/\/file\/d\/([^\/]+)/); if (match) id = match[1]; }
          if (id) return 'https://drive.google.com/thumbnail?id=' + id + '&sz=w800';
        } catch(e) {}
        return url;
      }
      function performSearch() {
        isInitialLoad = false;
        const c = document.getElementById('cat').value || 'ì „ì²´'; const a = document.getElementById('area').value || 'ì „ì²´'; const i = document.getElementById('item').value || 'ì „ì²´';
        const data = db.searchData(c, a, i);
        
        const categoryOrder = { 'êµì¬êµêµ¬': 1, 'ë³´ì¡°ê¸°ê¸°': 2, 'ì§„ë‹¨í‰ê°€ë„êµ¬': 3 };
        const isFilterActive = (c && c !== 'ì „ì²´') || (a && a !== 'ì „ì²´') || (i && i !== 'ì „ì²´');

        if (isFilterActive) {
          // v9: í•„í„° ê²€ìƒ‰ ì‹œ ì¢…ëª©ë³„/ìˆœë²ˆìˆœ ì •ë ¬
          fullData = data.map(d => ({ 
            ...d, ì¢…ëª©: d.ì¢…ëª© || 'ë¯¸ì…ë ¥', ì˜ì—­: d.ì˜ì—­ || 'ë¯¸ì…ë ¥', í’ˆëª…: d.í’ˆëª… || 'ë¯¸ì…ë ¥' 
          })).sort((a, b) => {
            const orderA = categoryOrder[a.ì¢…ëª©] || 99;
            const orderB = categoryOrder[b.ì¢…ëª©] || 99;
            if (orderA !== orderB) return orderA - orderB;
            return (a.ìˆœë²ˆ || '').localeCompare(b.ìˆœë²ˆ || '', undefined, { numeric: true, sensitivity: 'base' });
          });
        } else {
          // v9: ì „ì²´ ê²€ìƒ‰ ì‹œ ëœë¤ ë°°ì¹˜
          fullData = shuffleArray(data.map(d => ({ 
            ...d, ì¢…ëª©: d.ì¢…ëª© || 'ë¯¸ì…ë ¥', ì˜ì—­: d.ì˜ì—­ || 'ë¯¸ì…ë ¥', í’ˆëª…: d.í’ˆëª… || 'ë¯¸ì…ë ¥' 
          })));
        }
        renderUI();
        alert("ê²€ìƒ‰ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (ê²€ìƒ‰ ê²°ê³¼: " + fullData.length + "ê±´)");
      }
      function renderUI() {
        const res = document.getElementById('results'); const bar = document.getElementById('pagiBar');
        if (isInitialLoad) { res.innerHTML = ''; bar.style.display = 'none'; return; }
        const size = parseInt(document.getElementById('pageSize').value);
        const startIdx = (currentPage - 1) * size;
        currentRenderedData = fullData.slice(startIdx, startIdx + size);
        if (currentRenderedData.length === 0) { res.innerHTML = '<p style="text-align:center; padding:20px; color:var(--text-sub);">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; bar.style.display = 'none'; return; }
        res.innerHTML = '';
        currentRenderedData.forEach((d, idx) => {
          const card = document.createElement('div'); card.className = 'result-card'; card.onclick = () => showDetailModal(idx);
          const adminHtml = isAdmin ? `<div style="margin-top:8px"><button onclick="event.stopPropagation(); editItem(${idx})" style="font-size:11px; padding:3px 7px;">ìˆ˜ì •</button><button onclick="event.stopPropagation(); deleteItem(${idx})" style="font-size:11px; padding:3px 7px; color:red">ì‚­ì œ</button></div>` : '';
          card.innerHTML = `<div class="img-box"><img src="${getInstantImgUrl(d.ì‚¬ì§„)}" loading="lazy" onerror="this.src='https://raw.githubusercontent.com/ngc7331-kor/DHSE-Item-Search/main/icon-v9-512.png'"></div><div class="info-box"><h3>${d.í’ˆëª…}</h3><div class="info-grid"><div class="info-row"><b>ì¢…ëª©</b><span class="val">${d.ì¢…ëª©}</span></div><div class="info-row"><b>ì˜ì—­</b><span class="val">${d.ì˜ì—­}</span></div><div class="info-row"><b>ìˆœë²ˆ</b><span class="val">${d.ìˆœë²ˆ}</span></div><div class="info-row"><b>ìˆ˜ëŸ‰</b><span class="val">${d.ìˆ˜ëŸ‰}</span></div><div class="info-row full"><b>ìœ„ì¹˜</b><span class="val">${d.ìœ„ì¹˜}</span></div></div>${adminHtml}</div>`;
          res.appendChild(card);
        });
        bar.style.display = 'flex'; const nums = document.getElementById('pagiNums'); nums.innerHTML = '';
        const totalPages = Math.ceil(fullData.length / size); const startPage = Math.floor((currentPage - 1) / 10) * 10 + 1; const endPage = Math.min(startPage + 9, totalPages);
        if (startPage > 1) nums.innerHTML += `<button class="pagi-btn" onclick="changeP(${startPage-1})">ì´ì „</button>`;
        for (let p = startPage; p <= endPage; p++) { nums.innerHTML += `<button class="pagi-btn ${p===currentPage?'active':''}" onclick="changeP(${p})">${p}</button>`; }
        if (endPage < totalPages) nums.innerHTML += `<button class="pagi-btn" onclick="changeP(${endPage+1})">ë‹¤ìŒ</button>`;
      }
      function showDetailModal(idx) {
        const d = currentRenderedData[idx]; if (!d) return;
        document.getElementById('dt_img').src = getInstantImgUrl(d.ì‚¬ì§„);
        document.getElementById('dt_name').textContent = d.í’ˆëª…;
        document.getElementById('dt_cat').textContent = d.ì¢…ëª©;
        document.getElementById('dt_area').textContent = d.ì˜ì—­;
        document.getElementById('dt_num').textContent = d.ìˆœë²ˆ;
        document.getElementById('dt_loc').textContent = d.ìœ„ì¹˜;
        document.getElementById('dt_qty').textContent = d.ìˆ˜ëŸ‰;
        document.getElementById('detailModal').classList.add('show');
      }
      function closeDetailModal() { document.getElementById('detailModal').classList.remove('show'); }
      function changeP(p) { currentPage = p; renderUI(); window.scrollTo({ top: 0, behavior: 'smooth' }); }
      function toggleAdmin() { isAdmin = !isAdmin; document.querySelector('.admin-btn').classList.toggle('active'); document.getElementById('addBtn').classList.toggle('show'); renderUI(); }
      function openModal() { currentMode='add'; document.getElementById('mTitle').textContent = 'í•­ëª© ì¶”ê°€'; ['m_cat','m_area','m_num','m_item','m_qty','m_loc'].forEach(id => document.getElementById(id).value = ''); document.getElementById('m_prev').style.display = 'none'; document.getElementById('modal').classList.add('show'); }
      function closeModal() { document.getElementById('modal').classList.remove('show'); }
      function editItem(idx) { 
        const d = currentRenderedData[idx]; if (!d) return;
        currentMode = 'edit'; editD = d; document.getElementById('mTitle').textContent = 'í•­ëª© ìˆ˜ì •'; document.getElementById('m_cat').value = d.ì¢…ëª©; document.getElementById('m_area').value = d.ì˜ì—­; document.getElementById('m_num').value = d.ìˆœë²ˆ; document.getElementById('m_item').value = d.í’ˆëª…; document.getElementById('m_qty').value = d.ìˆ˜ëŸ‰; document.getElementById('m_loc').value = d.ìœ„ì¹˜;
        const img = getInstantImgUrl(d.ì‚¬ì§„); if(img) { document.getElementById('m_prev').src = img; document.getElementById('m_prev').style.display = 'block'; } else { document.getElementById('m_prev').style.display = 'none'; }
        document.getElementById('modal').classList.add('show');
      }
      function previewImg(e) { 
        const file = e.target.files[0], reader = new FileReader();
        reader.onload = (ev) => { 
          const img = new Image(); 
          img.onload = () => { 
            const cvs = document.createElement('canvas'); const maxDim = 600; const s = Math.min(maxDim/img.width, maxDim/img.height, 1);
            cvs.width = img.width * s; cvs.height = img.height * s;
            const ctx = cvs.getContext('2d'); ctx.drawImage(img, 0, 0, cvs.width, cvs.height);
            const resData = cvs.toDataURL('image/jpeg', 0.8); document.getElementById('m_prev').src = resData; document.getElementById('m_prev').style.display = 'block'; 
          }; 
          img.src = ev.target.result; 
        }; 
        if(file) reader.readAsDataURL(file);
      }
      async function saveData() { 
        const obj = { ì¢…ëª©: document.getElementById('m_cat').value, ì˜ì—­: document.getElementById('m_area').value, ìˆœë²ˆ: document.getElementById('m_num').value, í’ˆëª…: document.getElementById('m_item').value, ìˆ˜ëŸ‰: document.getElementById('m_qty').value, ìœ„ì¹˜: document.getElementById('m_loc').value, ì‚¬ì§„: document.getElementById('m_prev').style.display==='block' ? document.getElementById('m_prev').src : '' };
        let res = currentMode === 'add' ? await db.addData(obj) : await db.updateData(editD, obj);
        if (res.success) { alert(res.message); closeModal(); preload(); } else { alert(res.message); }
      }
      async function deleteItem(idx) { const d = currentRenderedData[idx]; if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { const res = await db.deleteData(d); alert(res.message); preload(); } }
    </script>
  </body>
</html>
